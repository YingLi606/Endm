#!/data/data/com.termux/files/usr/bin/bash
red(){ echo -e "\033[31m$1\033[0m"; }
green(){ echo -e "\033[32m$1\033[0m"; }

check_proot_install() {
    if ! command -v proot-distro >/dev/null 2>&1; then
        green "æ£€æµ‹åˆ°æœªå®‰è£…proot-distroï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£…..."
        pkg install proot-distro -y >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            red "proot-distroå®‰è£…å¤±è´¥/ä¸­æ–­ï¼Œè„šæœ¬é€€å‡ºï¼"
            exit 1
        fi
        green "proot-distroå®‰è£…æˆåŠŸï¼"
    fi
}

list_proot_distro() {
    clear
    proot-distro list
    echo
    green "åˆ—å‡ºå®Œæˆï¼ŒæŒ‰å›è½¦é”®è¿”å›èœå•..."
    read -r
    clear
}

install_proot_distro() {
    clear
    distro_name=$(whiptail --title "ğŸ“¦ å®‰è£…Proot-distroå®¹å™¨ï¼ˆæ³¨æ„å…¨éƒ¨å°å†™ï¼‰" --inputbox "è¯·è¾“å…¥è¦å®‰è£…çš„ç³»ç»Ÿåç§°ï¼ˆä¾‹ï¼šubuntu/debian/alpineï¼‰" 8 55 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && { clear; return; }
    if proot-distro install "$distro_name"; then
        green "âœ… ç³»ç»Ÿ $distro_name å®‰è£…æˆåŠŸï¼"
    else
        red "âŒ è¾“å…¥é”™è¯¯ï¼Œè¯¥ç³»ç»Ÿä¸å­˜åœ¨æˆ–å®‰è£…å¤±è´¥ï¼"
    fi
    echo
    green "æŒ‰å›è½¦é”®è¿”å›èœå•..."
    read -r
    clear
}

uninstall_proot_distro() {
    clear
    distro_name=$(whiptail --title "ğŸ—‘ï¸  å¸è½½Proot-distroå®¹å™¨" --inputbox "è¯·è¾“å…¥è¦å¸è½½çš„ç³»ç»Ÿåç§°" 8 50 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && { clear; return; }
    if proot-distro remove "$distro_name"; then
        green "âœ… ç³»ç»Ÿ $distro_name å¸è½½æˆåŠŸï¼"
        green "æ­£åœ¨æ¸…ç©ºProot-distroå·²å®‰è£…çš„ç³»ç»Ÿå®¹å™¨ç¼“å­˜..."
        proot-distro clear-cache
        green "âœ… ç¼“å­˜å·²æ¸…ç©ºï¼"
    else
        red "âŒ è¾“å…¥é”™è¯¯ï¼Œè¯¥ç³»ç»Ÿä¸å­˜åœ¨æˆ–å¸è½½å¤±è´¥ï¼"
    fi
    echo
    green "æŒ‰å›è½¦é”®è¿”å›èœå•..."
    read -r
    clear
}

start_proot_distro() {
     clear
     distro_name=$(whiptail --title "ğŸš€ å¯åŠ¨Proot-distroå®¹å™¨" --inputbox "è¯·è¾“å…¥è¦å¯åŠ¨çš„ç³»ç»Ÿåç§°" 8 50 3>&1 1>&2 2>&3)
     [ $? -ne 0 ] && { clear; return; }
     if proot-distro login "$distro_name"; then
         green "âœ… $distro_name ç³»ç»Ÿå·²é€€å‡ºï¼Œè¿”å›èœå•..."
     else
         red "âŒ å¯åŠ¨å¤±è´¥ï¼Œä½ å¯èƒ½æœªå®‰è£…è¯¥ç³»ç»Ÿæˆ–è¾“å…¥é”™è¯¯ï¼"
     fi
     echo
     green "æŒ‰å›è½¦é”®è¿”å›èœå•..."
     read -r
     clear
}

main_menu() {
    while true; do
        choice=$(whiptail --title "ğŸ“± Termux Proot-Distro ç®¡ç†å·¥å…·" --menu "è¯·é€‰æ‹©æ“ä½œ" 18 55 5 \
        "1" "ğŸ“‹ åˆ—å‡ºæ‰€æœ‰prootå®¹å™¨" \
        "2" "ğŸ“¦ å®‰è£…prootå®¹å™¨" \
        "3" "ğŸ—‘ï¸  å¸è½½prootå®¹å™¨" \
        "4" "ğŸš€ å¯åŠ¨prootå®¹å™¨" \
        "5" "ğŸšª é€€å‡ºè„šæœ¬" 3>&1 1>&2 2>&3)
        
        [ $? -ne 0 ] && { clear; green "è„šæœ¬å·²é€€å‡ºï¼"; exit 0; }
        
        clear
        case $choice in
            1) list_proot_distro ;;
            2) install_proot_distro ;;
            3) uninstall_proot_distro ;;
            4) start_proot_distro ;;
            5) clear; green "è„šæœ¬å·²é€€å‡ºï¼"; exit 0 ;;
            *) red "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°é€‰ï¼"; sleep 1; clear ;;
        esac
    done
}

Proot_distro() {
    check_proot_install
    clear
    main_menu
}