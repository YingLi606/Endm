#!/data/data/com.termux/files/usr/bin/bash

check_installed() {
    command -v "$1" >/dev/null 2>&1
}

install_with_progress() {
    local package="$1"
    local prompt="$2"
    pkg install -y "$package" >/dev/null 2>&1 &
    local pid=$!
    (
        local progress=0
        while kill -0 $pid 2>/dev/null; do
            echo $progress
            echo "# $promptï¼ˆè¿›åº¦ï¼š$progress%ï¼‰"
            progress=$(( progress < 90 ? progress + 10 : progress ))
            sleep 0.4
        done
        echo 100
        echo "# $prompt å®Œæˆï¼"
        sleep 0.2
    ) | whiptail --title "ğŸ”§ å®‰è£…ä¸­" --gauge "" 8 60 0
}

uninstall_with_progress() {
    local package="$1"
    local prompt="$2"
    pkg uninstall -y "$package" >/dev/null 2>&1 &
    local pid=$!
    (
        local progress=0
        while kill -0 $pid 2>/dev/null; do
            echo $progress
            echo "# $promptï¼ˆè¿›åº¦ï¼š$progress%ï¼‰"
            progress=$(( progress < 90 ? progress + 10 : progress ))
            sleep 0.4
        done
        echo 100
        echo "# $prompt å®Œæˆï¼"
        sleep 0.2
    ) | whiptail --title "ğŸ—‘ï¸ å¸è½½ä¸­" --gauge "" 8 60 0
}

termux_games_sl_submenu() {
    while true; do
        SUB_RESULT=$(whiptail --title "ğŸš‚ slï¼ˆå°ç«è½¦ï¼‰" \
            --menu "é€‰æ‹©æ“ä½œ" \
            15 60 4 \
            "1" "ğŸš‚ å¯åŠ¨sl" \
            "2" "ğŸŒˆğŸš‚ å¯åŠ¨slï¼ˆå½©è‰²ç‰ˆï¼‰" \
            "3" "ğŸ—‘ï¸ å¸è½½sl" \
            "4" "ğŸ”™ è¿”å›ä¸Šä¸€çº§" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then
            break
        fi

        case $SUB_RESULT in
            1)
                if ! check_installed sl; then
                    install_with_progress "sl" "æ­£åœ¨å®‰è£…slï¼ˆå°ç«è½¦ï¼‰"
                    if ! check_installed sl; then
                        whiptail --msgbox "âŒ slå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                clear
                sl
                read -p "æŒ‰ä¸‹å›è½¦é”®è¿”å›èœå•..."
                ;;
            2)
                if ! check_installed sl; then
                    install_with_progress "sl" "æ­£åœ¨å®‰è£…slï¼ˆå°ç«è½¦ï¼‰"
                    if ! check_installed sl; then
                        whiptail --msgbox "âŒ slå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                if ! check_installed lolcat; then
                    install_with_progress "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                    if ! check_installed lolcat; then
                        whiptail --msgbox "âŒ lolcatå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                clear
                sl | lolcat
                read -p "æŒ‰ä¸‹å›è½¦é”®è¿”å›èœå•..."
                ;;
            3)
                if check_installed sl; then
                    uninstall_with_progress "sl" "æ­£åœ¨å¸è½½slï¼ˆå°ç«è½¦ï¼‰"
                    if check_installed sl; then
                        whiptail --msgbox "âŒ slå¸è½½å¤±è´¥ï¼" 8 40
                    else
                        whiptail --msgbox "âœ… slå¸è½½å®Œæˆï¼" 8 40
                    fi
                else
                    whiptail --msgbox "â„¹ï¸ slæœªå®‰è£…ï¼Œæ— éœ€å¸è½½ï¼" 8 40
                fi
                ;;
            4)
                break
                ;;
        esac
    done
}

termux_games_nsnake_submenu() {
    while true; do
        SUB_RESULT=$(whiptail --title "ğŸ nsnakeï¼ˆè´ªåƒè›‡ï¼‰" \
            --menu "é€‰æ‹©æ“ä½œ" \
            15 60 4 \
            "1" "ğŸ å¯åŠ¨nsnake" \
            "2" "ğŸŒˆğŸ å¯åŠ¨nsnakeï¼ˆå½©è‰²ç‰ˆï¼‰" \
            "3" "ğŸ—‘ï¸ å¸è½½nsnake" \
            "4" "ğŸ”™ è¿”å›ä¸Šä¸€çº§" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then
            break
        fi

        case $SUB_RESULT in
            1)
                if ! check_installed nsnake; then
                    install_with_progress "nsnake" "æ­£åœ¨å®‰è£…nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                    if ! check_installed nsnake; then
                        whiptail --msgbox "âŒ nsnakeå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                clear
                nsnake
                read -p "æŒ‰ä¸‹å›è½¦é”®è¿”å›èœå•..."
                ;;
            2)
                if ! check_installed nsnake; then
                    install_with_progress "nsnake" "æ­£åœ¨å®‰è£…nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                    if ! check_installed nsnake; then
                        whiptail --msgbox "âŒ nsnakeå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                if ! check_installed lolcat; then
                    install_with_progress "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                    if ! check_installed lolcat; then
                        whiptail --msgbox "âŒ lolcatå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                        continue
                    fi
                fi
                clear
                nsnake | lolcat
                read -p "æŒ‰ä¸‹å›è½¦é”®è¿”å›èœå•..."
                ;;
            3)
                if check_installed nsnake; then
                    uninstall_with_progress "nsnake" "æ­£åœ¨å¸è½½nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                    if check_installed nsnake; then
                        whiptail --msgbox "âŒ nsnakeå¸è½½å¤±è´¥ï¼" 8 40
                    else
                        whiptail --msgbox "âœ… nsnakeå¸è½½å®Œæˆï¼" 8 40
                    fi
                else
                    whiptail --msgbox "â„¹ï¸ nsnakeæœªå®‰è£…ï¼Œæ— éœ€å¸è½½ï¼" 8 40
                fi
                ;;
            4)
                break
                ;;
        esac
    done
}

Termux_games() {
    while true; do
        MAIN_RESULT=$(whiptail --title "Termux å°æ¸¸æˆä¸“åŒº" \
            --menu "è®©æ‚¨è§£å†³æ— èŠçš„çƒ¦æ¼" \
            15 60 4 \
            "1" "ğŸŒˆ å®‰è£…lolcatï¼ˆå½©è‰²ç‰ˆæ ¸å¿ƒï¼‰" \
            "2" "ğŸš‚ slï¼ˆå°ç«è½¦ï¼‰" \
            "3" "ğŸ nsnakeï¼ˆè´ªåƒè›‡ï¼‰" \
            "4" "ğŸ”™ è¿”å›" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then
            break
        fi

        case $MAIN_RESULT in
            1)
                if check_installed lolcat; then
                    whiptail --msgbox "âœ… lolcatå·²å®‰è£…ï¼Œæ— éœ€é‡å¤æ“ä½œï¼" 8 40
                else
                    install_with_progress "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                    if check_installed lolcat; then
                        whiptail --msgbox "âœ… lolcatå®‰è£…å®Œæˆï¼" 8 40
                    else
                        whiptail --msgbox "âŒ lolcatå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼" 8 40
                    fi
                fi
                ;;
            2)
                termux_games_sl_submenu
                ;;
            3)
                termux_games_nsnake_submenu
                ;;
            4)
                break
                ;;
        esac
    done
}

