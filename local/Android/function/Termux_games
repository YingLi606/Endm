#!/data/data/com.termux/files/usr/bin/bash

check_installed() {
    command -v "$1" >/dev/null 2>&1
}

install_with_progress() {
    local cmd="$1"
    local package="$2"
    local prompt="$3"
    (
        local progress=0
        while [ $progress -lt 100 ]; do
            echo $progress
            echo "# $promptï¼ˆè¿›åº¦ï¼š$progress%ï¼‰"
            progress=$(( progress + 10 ))
            sleep 0.3
        done
        echo 100
        echo "# $prompt å®Œæˆï¼"
    ) | whiptail --title "å®‰è£…ä¸­" --gauge "è¿™å¯èƒ½éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå–å†³äºä½ çš„ç½‘ç»œå…³ç³»..." 10 60 0 &
    local gauge_pid=$!
    $cmd >/dev/null 2>&1
    local install_exit_code=$?
    wait $gauge_pid 2>/dev/null
    sleep 1
    if [ $install_exit_code -ne 0 ] || ! check_installed "$package"; then
        whiptail --msgbox "âŒ $package å®‰è£…å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œåæ‰‹åŠ¨æ‰§è¡Œï¼š$cmd" 8 60
        return 1
    fi
    return 0
}

uninstall_with_progress() {
    local cmd="$1"
    local package="$2"
    local prompt="$3"
    (
        local progress=0
        while [ $progress -lt 100 ]; do
            echo $progress
            echo "# $promptï¼ˆè¿›åº¦ï¼š$progress%ï¼‰"
            progress=$(( progress + 10 ))
            sleep 0.3
        done
        echo 100
        echo "# $prompt å®Œæˆï¼"
    ) | whiptail --title "å¸è½½ä¸­" --gauge "è¯·è€å¿ƒç­‰å€™..." 10 60 0 &
    local gauge_pid=$!
    $cmd >/dev/null 2>&1
    local uninstall_exit_code=$?
    wait $gauge_pid 2>/dev/null
    sleep 1
    if [ $uninstall_exit_code -ne 0 ] || check_installed "$package"; then
        whiptail --msgbox "âŒ $package å¸è½½å¤±è´¥ï¼" 8 40
        return 1
    fi
    whiptail --msgbox "âœ… $package å¸è½½å®Œæˆï¼" 8 40
    clear
    return 0
}

termux_games_sl_submenu() {
    while true; do
        SUB_RESULT=$(whiptail --title "ğŸš‚ slï¼ˆå°ç«è½¦ï¼‰" \
            --menu "é€‰æ‹©æ“ä½œ" \
            15 60 4 \
            "1" "ğŸš‚ å¯åŠ¨sl" \
            "2" "ğŸŒˆğŸš‚ å¯åŠ¨slï¼ˆå½©è‰²ç‰ˆï¼‰" \
            "3" "ğŸ—‘ï¸ å¸è½½sl" \
            "4" "ğŸ”™ è¿”å›ä¸Šä¸€çº§" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then break; fi

        case $SUB_RESULT in
            1)
                if ! check_installed "sl"; then
                    install_with_progress "pkg install -y sl" "sl" "æ­£åœ¨å®‰è£…slï¼ˆå°ç«è½¦ï¼‰"
                fi
                if check_installed "sl"; then
                    clear
                    sl
                    clear
                else
                    whiptail --msgbox "âŒ slæœªå®‰è£…æˆåŠŸï¼Œæ— æ³•å¯åŠ¨ï¼" 8 40
                fi
                ;;
            2)
                if ! check_installed "sl"; then
                    install_with_progress "pkg install -y sl" "sl" "æ­£åœ¨å®‰è£…slï¼ˆå°ç«è½¦ï¼‰"
                fi
                if ! check_installed "lolcat"; then
                    if ! check_installed "ruby"; then
                        install_with_progress "apt install -y ruby" "ruby" "æ­£åœ¨å®‰è£…rubyï¼ˆä¾èµ–ï¼‰"
                    fi
                    install_with_progress "gem install lolcat" "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                fi
                if check_installed "sl" && check_installed "lolcat"; then
                    clear
                    sl | lolcat
                    clear
                else
                    whiptail --msgbox "âŒ slæˆ–lolcatæœªå®‰è£…æˆåŠŸï¼Œæ— æ³•å¯åŠ¨å½©è‰²ç‰ˆï¼" 8 40
                fi
                ;;
            3)
                if check_installed "sl"; then
                    uninstall_with_progress "apt remove -y sl" "sl" "æ­£åœ¨å¸è½½slï¼ˆå°ç«è½¦ï¼‰"
                else
                    whiptail --msgbox "slæœªå®‰è£…ï¼Œæ— éœ€å¸è½½ï¼" 8 40
                fi
                ;;
            4)
                break
                ;;
        esac
    done
}

termux_games_nsnake_submenu() {
    while true; do
        SUB_RESULT=$(whiptail --title "ğŸ nsnakeï¼ˆè´ªåƒè›‡ï¼‰" \
            --menu "é€‰æ‹©æ“ä½œ" \
            15 60 4 \
            "1" "ğŸ å¯åŠ¨nsnake" \
            "2" "ğŸŒˆğŸ å¯åŠ¨nsnakeï¼ˆå½©è‰²ç‰ˆï¼‰" \
            "3" "ğŸ—‘ï¸ å¸è½½nsnake" \
            "4" "ğŸ”™ è¿”å›ä¸Šä¸€çº§" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then break; fi

        case $SUB_RESULT in
            1)
                if ! check_installed "nsnake"; then
                    install_with_progress "pkg install -y nsnake" "nsnake" "æ­£åœ¨å®‰è£…nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                fi
                if check_installed "nsnake"; then
                    clear
                    nsnake
                    clear
                else
                    whiptail --msgbox "âŒ nsnakeæœªå®‰è£…æˆåŠŸï¼Œæ— æ³•å¯åŠ¨ï¼" 8 40
                fi
                ;;
            2)
                if ! check_installed "nsnake"; then
                    install_with_progress "pkg install -y nsnake" "nsnake" "æ­£åœ¨å®‰è£…nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                fi
                if ! check_installed "lolcat"; then
                    if ! check_installed "ruby"; then
                        install_with_progress "apt install -y ruby" "ruby" "æ­£åœ¨å®‰è£…rubyï¼ˆä¾èµ–ï¼‰"
                    fi
                    install_with_progress "gem install lolcat" "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                fi
                if check_installed "nsnake" && check_installed "lolcat"; then
                    clear
                    nsnake | lolcat
                    clear
                else
                    whiptail --msgbox "âŒ nsnakeæˆ–lolcatæœªå®‰è£…æˆåŠŸï¼Œæ— æ³•å¯åŠ¨å½©è‰²ç‰ˆï¼" 8 40
                fi
                ;;
            3)
                if check_installed "nsnake"; then
                    uninstall_with_progress "apt remove -y nsnake" "nsnake" "æ­£åœ¨å¸è½½nsnakeï¼ˆè´ªåƒè›‡ï¼‰"
                else
                    whiptail --msgbox "nsnakeæœªå®‰è£…ï¼Œæ— éœ€å¸è½½ï¼" 8 40
                fi
                ;;
            4)
                break
                ;;
        esac
    done
}

Termux_games() {
    while true; do
        MAIN_RESULT=$(whiptail --title "Termux å°æ¸¸æˆä¸“åŒº" \
            --menu "è®©æ‚¨è§£å†³æ— èŠçš„çƒ¦æ¼" \
            18 60 5 \
            "1" "ğŸŒˆ å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰" \
            "2" "ğŸ—‘ï¸ å¸è½½lolcatï¼ˆå¦‚æ— ååº”ï¼Œè¯·å›è½¦ï¼‰" \
            "3" "ğŸš‚ slï¼ˆå°ç«è½¦ï¼‰" \
            "4" "ğŸ nsnakeï¼ˆè´ªåƒè›‡ï¼‰" \
            "5" "ğŸŒš é€€å‡º" \
            3>&1 1>&2 2>&3)

        if [ $? -ne 0 ]; then break; fi

        case $MAIN_RESULT in
            1)
                if check_installed "lolcat"; then
                    whiptail --msgbox "âœ… lolcatå·²å®‰è£…ï¼Œæ— éœ€é‡å¤æ“ä½œï¼" 8 40
                else
                    if ! check_installed "ruby"; then
                        install_with_progress "apt install -y ruby" "ruby" "æ­£åœ¨å®‰è£…rubyï¼ˆä¾èµ–ï¼‰"
                    fi
                    install_with_progress "gem install lolcat" "lolcat" "æ­£åœ¨å®‰è£…lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                fi
                ;;
            2)
                if check_installed "lolcat"; then
                    uninstall_with_progress "gem uninstall lolcat" "lolcat" "æ­£åœ¨å¸è½½lolcatï¼ˆå½©è‰²æ ¸å¿ƒï¼‰"
                else
                    whiptail --msgbox "lolcatæœªå®‰è£…ï¼Œæ— éœ€å¸è½½ï¼" 8 40
                fi
                ;;
            3)
                termux_games_sl_submenu
                ;;
            4)
                termux_games_nsnake_submenu
                ;;
            5)
                clear
                break
                ;;
        esac
    done
}